# 通用开发规范 v4.1（前后端通用 · 效率优先）

## 总则

- 效率优先
  - 交付与长期维护效率第一：一切决策以减少总成本（开发/测试/运维/迭代）为目标。
- 最简逻辑
  - 最小正确闭环优先：先达成可用的最小正确闭环，再做增量优化与扩展。
  - 奥卡姆剃刀：同等价值优先选择更简单、更直接的实现。
- 模块化为效率服务
  - 分层与职责清晰：仅在显著降低心智负担与重构成本时引入分层；反对为“形式化模块化”而模块化。
- Local-first 与合规
  - 默认本地可运行与可验证：保护隐私，避免数据再分发风险，默认仅开放本地开发白名单。
- 可复现性
  - 关键产出附元信息：算法版本、参数、数据时间窗、生成时间与时区必须写入 meta，支持回放与对拍。
- 依赖与职责
  - 最小可行子集：以最小可行集合启动，按需求引入 stores/router/workers/tests 等。
  - 单向依赖：上层只依赖下层稳定接口，禁止跨层耦合与“抄近道”。
  - 单一职责：每个模块只做一件事并把它做好；复杂流程下沉 services。
  - 面向接口：暴露稳定接口/类型屏蔽实现细节，便于替换与测试。
- 质量与演进
  - 根因修复优先：先定位根因，修复后补防护；临时 workaround 必须标注并限期回收。
  - 最优逻辑重构：修改与新增均以最简洁的逻辑重构实现，避免“补丁摞补丁”式堆砌。
  - 避免过度拆分：仅当拆分显著提升理解与变更效率时才拆分，否则合并简化。
- 可观测与回归
  - 全链路可观测：关键流程有日志/度量/追踪；trace_id 贯通前后端。
  - 黄金样例与基准：关键输出建立黄金样例和对拍基准，升级后对比差异。
- 思考方法规范
  - 对每个需求都要进行至少十轮“三解合优，自我校验”（三解合优即针对需求提出至少三种可行且路径差异明显的方案，取长补短整合成一个最优解；然后针对这个最优解再自我质疑提出风险，再针对这个风险继续做三解合优自我校验，如此循环往复，确保思考结果是稳妥全面的，不会顾此失彼）后，再汇报方案待我确认。
- 输出与文档
  - 输出规范：涉及代码的输出放入代码块；默认需要输出的文件逐行注释全量输出（如有）。
  - 决策记录/ADR：重要技术与架构决策以 ADR 记录目标、备选方案、取舍与影响，取代冗长的口头推演。
  - 风险审查清单：上线前以标准化清单核对性能/安全/回滚/监控等，避免主观遗漏。
- 变更策略
  - 小步快跑可回滚：改动可分段回滚；以黄金样例对拍验证。
  - 兼容演进：新增字段仅追加；破坏性变更升级版本并给出迁移说明与自动迁移脚本优先。
- 安全与合规
  - 隐私最小化：默认不收集使用数据；如需采集必须有告知、开关与数据保留策略。
  - 错误脱敏：对外统一错误模型，隐藏内部堆栈与敏感信息。
- 团队协作
  - 代码评审为默认门禁：双人审阅或 CODEOWNERS 保护关键目录，SLA 明确。
  - 约定优于配置：统一风格、工具链与脚手架，降低个体差异带来的摩擦。

---

## 标准目录（通用建议）

- 前端（示例）
  ```
  src/
  ├─ assets/            # 静态资源（参与构建）
  ├─ components/
  │  ├─ ui/             # 通用无业务 UI 原子组件
  │  └─ features/       # 业务功能视图容器
  ├─ composables/       # 响应式编排（useXxx）
  ├─ constants/         # 全局常量与枚举
  ├─ charts/            # 主题、Option 生成、图层渲染（纯函数）
  ├─ api/               # HTTP 客户端与 DTO
  ├─ services/          # 业务服务（聚合/缓存/调度）
  ├─ styles/            # 全局样式与变量
  ├─ utils/             # 纯函数工具库
  ├─ types/             # 类型（TS 或 JSDoc typedef）
  ├─ docs/              # 富文本文档、用户手册（新增）
  ├─ adr/               # 架构决策记录（新增）
  └─ main.ts(x)/App.vue
  ```

- 后端（示例）
  ```
  backend/
  ├─ app.py             # 应用实例与中间件
  ├─ routers/           # 路由（仅参数校验与调用服务）
  ├─ services/          # 业务流程（聚合/缓存/调度）
  ├─ datasource/        # 外部数据源适配（HTTP/DB/SDK）
  ├─ indicators/        # 领域算法（纯函数/可单测）
  ├─ models/            # Pydantic/DTO/枚举
  ├─ utils/             # 时间/序列化/重试/并发
  ├─ cache/             # 缓存与索引（可选）
  ├─ migrations/        # 数据库迁移脚本（新增）
  ├─ observability/     # 日志/度量/追踪配置（新增）
  ├─ docs/              # OpenAPI/README/运行手册（新增）
  └─ settings.py        # 配置/常量
  ```

---

## 模块职责与“必选/可选”

- assets：媒体资源。必选。
- components/ui：无业务通用组件，仅 props/emits。必选。
- components/features：薄容器，连接 composables。必选。
- composables（前端）/routers（后端）：参数与状态编排；不直连底层数据源。必选。
- constants：端点/枚举/默认参数。必选。
- charts（前端）：纯函数生成 option；主题集中。可视化项目必选。
- api：HTTP 客户端/拦截器/DTO；统一错误模型。后端/远程数据时必选。
- services：业务聚合/缓存/流程编排；可替换可测试。必选。
- stores/router/workers/tests/types：按需引入，避免为模块而模块。

---

## 代码归属决策流（简化）

- 与响应式/页面状态相关 → 放 composables（前端）。
- 纯算法/工具 → 放 utils（或 indicators）。
- HTTP/DTO → 放 api。
- 多步业务流程/缓存/聚合 → 放 services。
- 图表主题/option → 放 charts（纯函数）。
- 其余仅 UI 行为 → 放 components（尽量薄）。

---

## 数据契约与时间

- 时间统一：后端输出 ISO8601（含时区），前端按约定时区渲染（如 Asia/Shanghai）。
- 核心 DTO 稳定：Candle、IndicatorDict、Meta 等定义版本与参数写入 meta。
- 兼容演进：新增字段仅追加；破坏性变更升版本并提供迁移与对拍说明。
- 分页/窗口：大数据默认分页/时间窗限制；明确最大点数与降采样策略。
- 单调时钟与顺序（新增）：涉及排序/重试的时序逻辑使用单调时钟；明确幂等键与去重规则。
- Schema 管理（新增）：以 OpenAPI/JSON Schema 定义契约，CI 中进行 schema 破坏性变更检测。

---

## 错误模型与重试

- 统一错误对象：code、message、trace_id、hint（可选）。
- 分级重试：仅对可重试类错误（超时/限流/临时失败）指数退避；参数/鉴权错误直接失败。
- 取消与竞态：仅保留最新请求（AbortController/任务令牌）。
- 日志与追踪：后端记录堆栈但对外隐藏；前后端贯通 trace_id。
- 幂等性（新增）：写操作支持幂等键（Idempotency-Key）；重试必须保持效果一致。
- 错误分类与告警（新增）：用户可恢复/不可恢复/系统级分级上报，SLO 驱动告警阈值。

---

## 性能预算与并发

- 响应预算：参数变更到可见更新如渲染 < 300ms，冷启 < 1.5s（按项目设定）。
- 节流/去抖：输入/滚动默认去抖 ~300ms；渲染与尺寸变更按需节流。
- 并发策略：队列或“最新胜出”；后台刷新不阻塞首屏。
- 阈值开关：大数据触发降采样/分段加载/禁用昂贵效果；必要时移交 worker。
- 资源预算（新增）：内存/CPU/网络预算纳入 PR 审查；重型任务可选 WebWorker/批处理。
- 性能基线与对拍（新增）：关键视图建立性能快照与对拍基线，CI 中回归检测。

---

## 安全与合规（Local-first）

- 仅本地访问：默认 CORS 白名单为本地开发地址；避免默认公网暴露。
- 不再分发数据：导出的报告/快照默认不包含敏感原始数据；开发模式显式开启。
- 隐私最小化：默认不收集使用数据；如需采集须告知、开关与数据保留策略。
- 输出脱敏：错误与日志避免包含敏感信息。
- 供应链安全（新增）：依赖许可清单（license），SBOM 生成，Dependabot/ Renovate 自动升级与锁版本策略。
- 密钥治理（新增）：secret scanning、KMS/ Vault 管理；严禁硬编码密钥。
- SAST/DAST（新增）：静态/动态安全扫描纳入 CI，阻断严重风险。

---

## 工程规范

- 类型与风格：TS 严格模式或 JSDoc typedef；ESLint+Prettier；提交前自动修复。
- 路径别名：统一 @ 指向 src；后端使用模块化导入约定。
- 命名：组件 PascalCase；composable useXxx；服务 XxxService；常量统一前缀或全大写。
- 配置与密钥：通过环境变量/配置文件管理；禁止硬编码密钥。
- 构建与包体：依赖分层与按需引入；避免“大而全”库无脑打入主包。
- 提交规范（新增）：Conventional Commits；变更自动生成 Changelog。
- 预提交钩子（新增）：lint/test/typecheck/secret-scan 纳入 pre-commit。
- 代码所有权（新增）：CODEOWNERS 保护关键目录；审阅人最少 2 人或风控例外流程。
- 发布流水线（新增）：CI 产物可追溯（构建号/commit/SBOM），支持一键回滚。

---

## 版本与元信息

- 语义化版本：MAJOR.MINOR.PATCH；破坏性变更清晰标注。
- 产出元信息：图表/报告嵌入 algo_version、参数、数据窗、生成时间、timezone。
- Changelog：用户可读 + 研发可复现；必要时附对拍图或快照差异。
- 可溯源产物（新增）：构建产物记录 git SHA、依赖哈希、编译器版本与平台信息。

---

## 测试与回归

- 优先级：utils 与算法（indicators）单测；charts option 快照测试；关键交互最小集成测试。
- 黄金样例：导出 HTML/PNG 作为回归基准；升级后对拍差异。
- 容错测试：网络/空数据/超阈值等异常路径需覆盖。
- 测试金字塔（新增）：单测为基座，契约测试和组件测试为中层，E2E 精选关键路径。
- 变异测试（新增）：对关键算法启用变异测试以提升断言质量（可选）。
- 基准测试（新增）：性能关键模块提供 benchmark 基准，升级后对比。

---

## 前端要点（补充）

- API 客户端统一：一个 axios 实例 + 拦截器（trace_id/错误模型/超时/重试）。
- 状态编排：页面/局部状态放 composables；全局状态按需引 stores，避免“一把梭全局化”。
- 图表渲染：默认 Canvas；导出 SVG/PNG 时临时切换；主题与颜色集中管理。
- 导出策略：PNG/JPG/SVG/HTML 自包含；默认“合规模式”不含原始数据，支持开发模式切换。
- 索引与缓存：Local-first 缓存索引/配置，后台刷新不阻塞 UI。
- 可访问性（新增）：a11y 基线（语义标签/焦点管理/对比度/键盘导航）。
- 加载体验（新增）：Skeleton/占位符/渐进数据；错误边界兜底。
- 国际化（新增）：i18n 资源按路由分包，缺省回退与时区/数字本地化。

---

## 后端要点（补充）

- 路由薄，服务厚：路由仅做校验与调用服务；聚合/缓存/重采样在 services。
- 数据源适配：datasource 层屏蔽外部 API 差异与字段映射；失败时提供可诊断错误。
- 缓存策略：热数据 TTL/LRU；本地磁盘缓存可选；暴露“是否命中缓存”元信息。
- 错误泄露控制：DEBUG 返回详细错误；生产仅返回标准错误对象。
- 可观测性：结构化日志、基本度量（请求时长/错误率/缓存命中），trace_id 贯穿调用链。
- 数据库迁移（新增）：版本化迁移（如 Alembic/Flyway），向前向后脚本双向可用。
- 幂等与一致性（新增）：写路径提供幂等键；分布式场景采用去重表/乐观锁/重试语义清晰。
- 契约优先（新增）：OpenAPI 驱动的契约开发与客户端生成；在 CI 守护破坏性变更。
- 限流与熔断（新增）：外部依赖增加限流/熔断/隔离舱；降级路径可验证。

---

## 反模式清单（禁止）

- 为模块而模块：无复用/隔离价值却强行抽象。
- 补丁摞补丁：连续 workaround 叠加，不做根因修复与回收计划。
- 上帝模块/组件：把路由/数据源/算法/缓存/视图堆在一起，导致不可测、难演进。
- 跨层耦合：视图或控制层绕过服务直接操作数据源或实现细节。
- 缺少元信息：图表/报告无版本与参数标记，导致不可复现。
- 过度拆分：将顺畅流程拆成过多层级，增加心智负担与链路长度。

---

## 启动清单（最小可行）

- 目录与约定建立：最小可行子集可运行。
- API 基础设施：客户端/错误模型/超时与重试完成。
- 首条业务链路：services 拉取蜡烛 → 计算指标 → 返回图层。
- charts 基线：主题与基础 option 生成器（纯函数）。
- composables/useXxx：最小交互闭环。
- 导出能力：PNG/JPG/SVG/HTML 可用，含元信息。
- 性能预算与阈值：常量定义完成并在 meta 暴露。
- 基础测试：utils 单测 + charts 快照 + 核心集成一条链路。
- CI 基线（新增）：lint/typecheck/test/构建与产物归档；SBOM 与依赖扫描开启。
- 回滚与监控（新增）：灰度/特性开关/一键回滚脚本，基本日志与告警上线即位。

---

## 落地建议（变更策略）

- 先收口后扩展：先清理重复与冗余（重复请求/刷新、死文件），再做新能力。
- 小步可回滚：每次重构步长可控，保留回滚点；改动后以黄金样例对拍。
- 文档即代码：对外接口/错误模型/元信息与阈值写入 constants/types，并在 README/规范同步。
- 特性开关与灰度（新增）：风险功能走开关与小流量；明确回滚与关闭策略。
- ADR 常态化（新增）：关键决策 24h 内补齐 ADR；定期回顾与归档。

---

## 协作与治理（新增）

- DoD（完成定义）：代码/测试/文档/监控/回滚/安全检查全部达标方可合并。
- 代码评审 SLA：工作日 24h 内完成初评；跨团队变更需双侧 OWNER 通过。
- 值班与交接：明确 on-call 轮值，交接清单可复用。
- 知识沉淀：问题复盘与知识库更新纳入验收项。

---
