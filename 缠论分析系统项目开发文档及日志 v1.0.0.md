# ChanTheory 项目架构与关键控制规范 v1.0（共识稿）

本文档汇总截至目前已达成的架构设计与关键控制因素，作为后续开发与验收的统一依据。以效率优先、最简逻辑、Local-first、可复现为最高原则。

## 0. 范围与目标

- 目标

  - 建立正确骨架，一步到位：先把架构与数据底座搭好，再在其上快速迭代。
  - 数据以远端为权威，本地持久化为稳定支撑：网络不可用/不稳定时可用，且可被重建与校正。
  - 最小存储、最大可复现：仅存必要原始数据与因子，其他派生即时计算。

- 总原则
  - 效率优先（交付与维护成本最低）
  - 最简逻辑（先小闭环、后增量）
  - 模块化为效率服务（职责清晰、可替换可测试）
  - Local-first 与合规（默认本地运行，不再分发敏感原始数据）
  - 可复现性（元信息完整、对拍可依）

---

## 1. 架构总览

- 后端（FastAPI + SQLite）

  - 数据采集 → 落库（权威单一真相源） → 业务仅读库 的 ETL 解耦。
  - SQLite（WAL）单库：candles（仅存不复权 none）、adj_factors（复权因子），可选 coverage 辅助表。
  - 数据源优先级：分钟线按实现切换主/备，日线按 AK 优先回退。
  - 重采样与复权即时计算：分钟派生高分钟、日派生周/月；qfq/hfq 按因子即时计算。
  - 后台任务：自选池后台仅保证 1d 近端；（分钟与对账后续按需扩展）
  - 统一错误与元信息：稳定 API 契约与可诊断 meta 字段。

- 前端（Vue3 + Vite + ECharts v6）
  - 单一全局样式（global.css，CSS 变量驱动；预留黑/白主题）
  - charts/theme.js 映射 CSS 变量 → ECharts 主题
  - 仅保留最新请求（AbortController）+ 防抖，指标等即时计算
  - 容器组件：WatchlistPanel（自选）、StorageManager（历史数据管理）
  - 设置与部分状态采用浏览器 LocalStorage 持久化；后端提供 config.json 用于后端参数与资源路径等配置

---

## 2. 数据模型与持久化

- 存储介质

  - SQLite（WAL 模式）：跨平台、零运维、事务安全、可 UPSERT。
  - 后续如规模显著扩大再评估 DuckDB/Parquet 归档（保持对外契约不变）。

- 表结构（概要）

  - candles（仅存 adjust='none'）
    - 主键：symbol, freq('1m'|'1d'), adjust('none'), ts(epoch ms)
    - 列：open, high, low, close, volume, amount?（源有则存）, source, fetched_at(ISO), revision?
    - 可选：turnover_rate?, trading_status?（源有则存，源无则置 NULL）
  - adj_factors（复权因子）
    - 主键：symbol, date(自然日)
    - 列：qfq_factor, hfq_factor
  - coverage（可选，缺口探测与留痕）
    - 主键：symbol, date, freq
    - 列：bar_count, first_ts, last_ts

- 存储策略
  - 仅存不复权序列 + 因子表：qfq/hfq 即时计算，避免 3 倍膨胀。
  - 不存技术指标（MA/MACD/KDJ/RSI…）：均在使用时本地计算。

---

## 3. 数据拉取与入库策略（共识）

- 日线（1d）

  - 每次全量拉取 + 覆盖更新（DELETE→INSERT 或批量 UPSERT）
  - 轻量、权威、持续校正最省心

- 分钟（1m/5m/15m/30m/60m）

  - 以“近端判定”为唯一触发条件：比较“应当已生成的最后一根 K 的结束时刻”与本地缓存 meta.last_ts
  - 未达标时执行“整窗直拉”（从历史起点到当前），结果写入缓存表；若主源失败则按实现进行兜底（见重采样）
  - 不使用“近窗 N 天覆盖/窗外增量回灌”的策略；不做逐日 DELETE→INSERT 纠偏

- 不足时高周期补洞（本地重采样）
  - 若分钟主拉取失败或数据不足，执行 1m → 5/15/30/60m 的本地重采样兜底（按交易会话切片）
  - 日 → 周/月：W-FRI 对齐与自然月末对齐本地重采样

- 一切业务均 只读本地数据库（采集与处理彻底解耦）

---

## 4. 复权与重采样

- 复权

  - 仅存因子表 + 不复权价格序列，读取 qfq/hfq 时即时套用：
    - 价格 × factor，成交量 ÷ factor（保精度）
  - 因子缺失回退 none，并在 meta.hint 标注（如有）

- 重采样
  - 分钟 → 5/15/30/60m：按交易日切片，开=首、收=尾、高=最大、低=最小、量/额求和；末段不足可丢弃并提示
  - 日 → 周/月：W-FRI 对齐与自然月末对齐
  - 全部本地完成，不依赖远端派生

---

## 5. 衍生列存储策略

- 可稳定本地计算的，不拉取不存储

  - change/change_pct（涨跌额/幅）、amplitude（振幅）等基于 O/H/L/C 的衍生
  - 全部在使用时即时计算

- 依赖外部口径/本地难以稳定计算的，源有则拉取并存

  - turnover_rate（换手率）（依赖股本口径）
  - trading_status / suspended（交易状态/停牌）
  - amount（成交额）（不建议用价 × 量近似）

- 技术指标一律不存储，使用时本地计算

---

## 6. API 契约与元信息

- /api/candles

  - 入参：code, freq(1m|5m|15m|30m|60m|1d|1w|1M), start, end, adjust(none|qfq|hfq), include, ma_periods, trace_id
  - 出参：
    - candles: [{t,o,h,l,c,v}]
    - indicators: 选填（本地计算结果）
    - meta：
      - timezone="Asia/Shanghai"
      - source（em|sina|ak|tx|resample）
      - source_key（稳定方法键，如 A_1d_a；重采样时为 resample_1m_to_5m 等）
      - downsample_from（当由 1m 或 1d 重采样生成时分别为 "1m" 或 "1d"，否则为 null）
      - is_cached（恒 True：来自本地或拉取后已落本地）
      - algo_version、generated_at、trace_id

- 错误模型
  - DEBUG=True：detail 含回溯
  - DEBUG=False：标准 {code,message,trace_id}，日志落回溯

---

## 7. 后端模块化

- app.py：FastAPI 实例与中间件、启动任务
- routers：candles（主数据）、symbols（索引与健康）、storage（用量/清理/迁移/对账）、watchlist（自选）
- services：
  - market（读取 → 复权 → 重采样）
  - storage（SQLite 读写、UPSERT、缓存元信息重建、LRU/TTL 清理）
  - symbol_index（索引构建缓存）
  - reconcile（预留：近端对账与回补）
- datasource：eastmoney（分钟/基金）、akshare（日线/回退/因子）
- db/sqlite.py：连接、PRAGMA、DDL、online backup
- utils：time（ISO/时区）、resample、errors、retry、trading_calendar

---

## 8. 前端结构与交互

- 样式与主题

  - 单一全局样式 global.css（CSS 变量）
  - 预留 theme-dark.css/theme-light.css；默认跟随系统，支持显式切换
  - charts/theme.js 从 CSS 变量读取并映射 ECharts v6

- 请求与并发

  - 统一 axios 实例（trace_id、错误模型、可选重试）
  - 仅保留最新（AbortController），指标/参数变更防抖（~250ms）

- 容器组件

  - WatchlistPanel：自选维护，展示后台同步状态，手动触发同步
  - StorageManager：数据库占用查看、清理（按标的/时间/频率）、对账占位、数据库路径迁移

- 导出
  - 默认“合规模式”（不内嵌原始数组，HTML 快照亦默认不包含 dataset），ECharts v6；开发模式可切换

- 设置与持久化
  - 前端交互与显示层设置（如 MA/量窗/复权/图形样式等）采用浏览器 LocalStorage 持久化
  - 后端提供 /api/user/config，用于后端参数（db_path、并发/重试、自选等）与安全迁移

---

## 9. 用户配置与存储路径（文件）

- 持久层

  - 单文件 config.json（原子写入 + 滚动备份 .bak/.bak2）
  - 后端提供 GET/PUT /api/user/config 读写；前端显示层设置不经由该接口

- 默认路径与可配置

  - 默认放在项目根目录（你的偏好）
  - 用户可指定 config 与数据库路径；变更后由后端执行安全迁移

- 配置变更监听
  - 镜像文件 config.applied.json + 文件监听（或轮询）
  - 发现 db_path 变更 → 校验 → 复制 → 完整性检查 → 切换连接；失败回滚

---

## 10. 背景任务与调度

- 启动后后台同步（不阻塞 UI）
  - 自选池：并发（建议 2–4）对每个标执行“1d 全量覆盖/校正”
  - 当前未包含分钟级同步；如需扩展分钟近端保障，另行按需开启

- 夜间对账（预留）
  - 设计为近端对账与回补（分钟 → 日重采样对比源日线）；当前未启用，可先提供手动触发占位

- 在线备份/健康检查
  - 周期性 online backup（保留 1–2 份轮换快照），PRAGMA integrity_check

---

## 11. 性能与并发控制

- 请求并发

  - 自选同步并发建议：3
  - 重试：429/超时指数退避（基 500ms、重试 ≤ 2）

- 大数据阈值
  - 点数超过阈值（如 50k）禁用昂贵效果（阴影/平滑），提示缩短时间窗或切粗粒度

---

## 12. 安全与合规

- 本地访问优先：CORS 白名单仅本地开发地址
- 不再分发原始敏感数据：导出默认不含原始数组（可切开发模式）
- 隐私最小化：默认不收集使用数据；如需，显式告知与开关

---

## 13. 风险与对策

- 整窗直拉可能受上游左端窗口限制
  - 对策：按“近端唯一判定”衡量是否需要更新；接受上游左端限制

- 源限流/超时
  - 对策：并发限流、指数退避、失败重试；错峰与任务队列

- 特殊交易日分钟数异常
  - 对策：交易日历与特殊日白名单、合理容差

- 因子缺失/修订
  - 对策：fallback none + 后续对账回补（预留），meta.hint 标注

- 用户手改 config.json 导致不一致
  - 对策：镜像+监听，发现变更走安全迁移流程，失败回滚并提示

- 存储膨胀
  - 对策：StorageManager 可视化占用；提供清理与重建；如需再加配额/归档

---

## 14. 默认参数（建议）

- fetch.concurrency = 3
- retry.max_attempts = 2
- retry.base_delay_ms = 500
- reconcile_recent_days = 3（~5）
- DEBUG = 开发 True / 生产 False

---

## 15. 路线与交付

- 一步到位新骨架
  - 后端：SQLite DDL/PRAGMA、datasource、storage（缓存与元信息）、market（复权/重采样）、routers（candles/storage/watchlist/config）、meta 扩展
  - 前端：global.css + charts/theme.js、统一 axios、仅保留最新、WatchlistPanel/StorageManager、设置与状态 LocalStorage 持久化

- 验收
  - 分钟近端判定 + 整窗直拉 + 缓存可复现
  - 1d 全量校正可复现
  - 读取 qfq/hfq 与高周期重采样正确
  - 自选后台同步不阻塞 UI（当前仅 1d）
  - 数据库路径修改可监听并安全迁移
  - 导出（合规）与主题切换预留生效

---

## 16. 术语对照（快速参考）

- 近端：在当前会话/粒度下，应当已生成的最后一根 K 的结束时刻（右端）
- 整窗直拉：以历史起点→当前的全历史拉取（接受上游左端限制）
- 兜底重采样：主抓取失败或不足时，使用 1m 或 1d 本地重采样生成目标粒度

---

## 17. 技术执行规范整理（随开发进程随时更新）

### 17.1. 标的索引拉取与本地数据库存储

- 总则

  - 聚焦 A / ETF / LOF 三类，覆盖规则、边界、方法、接口、数据库结构与统计摘要全链路。可直接迁移到新对话作为提示词，也可作为技术文档用于详细追溯。

- 范围与目标

  - 范围
    - 仅覆盖三类标的：A（沪深京 A 股）、ETF（场内 ETF）、LOF（场内 LOF）。
    - 输出统一索引到本地 SQLite，提供查询与摘要统计 API。
  - 目标
    - 完整、可配置、顺序可控的“全量索引”构建，确保本地的单一真相源（symbol_index）。
    - key point 不删除、仅覆盖（UPSERT），避免因上游抖动导致本地数据丢失。
    - key point 可重试、可观测、可回归（NDJSON 结构化日志 + 快照表）。

- 业务主流程（按业务逻辑顺序）

  - Step 0 配置加载与守护
    - 读取 config.json，关键字段 symbol_index_categories（数组）决定“拉取哪些类别”与“执行顺序”（仅允许 A、ETF、LOF；非法项忽略；未列明的受支持类将按默认顺序追加，确保覆盖）。
    - 配置文件支持热加载（原子写 + 镜像 + 文件监听），变更后自动应用。
  - Step 1 后台刷新任务触发
    - 启动时尝试触发一次后台刷新（不阻塞服务）。
    - 用户可调用 POST /api/symbols/refresh 手动触发（立即返回 building=true）。
  - Step 2 并发抓取（按配置顺序构建任务桶）
    - 对每个类别调用“主接口 + 后备接口”抓取全量列表，归一为 (symbol, name, market, type)。
    - 支持通用短重试（指数退避 + 抖动）、并发度受 fetch_concurrency 限制，单分类超时保护（默认 180s）。
  - Step 3 多桶合并（按优先级覆盖）
    - key point 合并优先级：A > ETF > LOF（同 symbol 冲突时，高优覆盖低优）。
    - 以 symbol 为键，最终输出有序列表（按 symbol 升序）。
  - Step 4 仅 UPSERT 入库
    - 写库仅使用 UPSERT（不 DELETE），空合并结果则跳过写库（日志 WARN）。
  - Step 5 统计摘要快照
    - 写库后进行 DB 实时聚合（by type 与 by type×market）。
    - key point 计算 delta_by_type：new/updated/untouched/total，并写入快照表 symbol_index_summary。
      - new：本次合并中出现而旧库不存在的 symbol（按本次条目的 type 计数）。
      - updated：旧库已存在而本次被覆盖/更新的 symbol（按本次条目 type 计数；不做字段变更比对，存在即视为更新）。
      - untouched：旧库存在而本次未覆盖的 symbol（按旧条目 type 计数）。
      - total：写后 DB 实际分组总量（覆盖回 delta_by_type.total）。
  - Step 6 API 返回
    - GET /api/symbols/index：返回 DB 中的 items 列表、行数、是否构建中等。
    - GET /api/symbols/summary：返回 by_type/by_type_market，总是尽量附带 latest_delta 与 snapshot_at。

- 类别与数据源（主/备）与字段归一化

  - A 股（type="A"）
    - 主接口：ak.stock_info_a_code_name
      - 列映射：code → symbol，name → name。
    - 后备接口（合并去重补全）：
      - 上证主板：ak.stock_info_sh_name_code(symbol="主板A股")（证券代码/证券简称）
      - 上证科创：ak.stock_info_sh_name_code(symbol="科创板")（证券代码/证券简称）
      - 深证 A 股：ak.stock_info_sz_name_code(symbol="A股列表")（A股代码/A股简称）
      - 北证 A 股：ak.stock_info_bj_name_code（证券代码/证券简称）
    - market 兜底映射：
      - key point \_infer_market_for_a：代码前缀作兜底。SH（600/601/603/605/688/689）、SZ（000/001/002/003/300/301）、BJ（430/83x/87x/871…等）。
  - ETF（type="ETF"）
    - 主接口：ak.fund_etf_spot_em（代码/名称）
    - 后备接口：ak.fund_etf_category_sina(symbol="ETF基金")（代码/名称）
    - market 兜底：key point \_infer_market_by_prefix_general：上证多为 5xxxx/51x，深证多为 15x/16x。
  - LOF（type="LOF"）
    - 主接口：ak.fund_lof_spot_em（代码/名称）
    - 后备接口：ak.fund_etf_category_sina(symbol="LOF基金")（代码/名称）
    - market 兜底：同 ETF 的通用前缀映射。
  - 归一化通用规则
    - key point \_norm_code_name 针对不同中文/英文列名做映射，取出 (symbol, name)。
    - 去空白、去重（主优先、后备补齐）。
    - 输出结构统一为：{"symbol": str, "name": str, "market": str, "type": str}。

- 配置与顺序控制

  - config.json
    - 字段 symbol_index_categories（List[str]）：仅允许 "A"、"ETF"、"LOF"。
    - key point 顺序决定抓取与合并优先级桶的执行顺序，且配合固定的类别优先级（A>ETF>LOF）确保最终冲突覆盖逻辑。
    - 非法值忽略；未列明的受支持类会自动按默认顺序追加（确保不丢类）。
  - 热加载
    - 后端守护线程监听 config.json 变更，自动应用（并发参数、重试参数、DB 路径迁移、类别顺序仅在刷新时生效）。

- 数据库结构（SQLite）

  - 表：symbol_index（索引真相源）
    - 主键：symbol
    - 列：symbol TEXT PRIMARY KEY, name TEXT NOT NULL, market TEXT, type TEXT, updated_at TEXT NOT NULL
    - key point 写入策略：仅 UPSERT；不执行 DELETE。
  - 表：symbol_index_summary（索引快照，幂等创建）
    - 主键：snapshot_at（ISO8601）
    - 列：
      - snapshot_at TEXT PRIMARY KEY
      - total_rows INTEGER NOT NULL（刷新后 symbol_index 总行数）
      - by_type_json TEXT NOT NULL（JSON 数组，如 [{"type":"A","n":1234},...]）
      - by_type_market_json TEXT NOT NULL（JSON 数组，如 [{"type":"ETF","market":"SZ","n":88},...]）
      - delta_by_type_json TEXT（JSON 数组，如 [{"type":"A","total":..., "new":..., "updated":..., "untouched":...},...]）
    - key point DDL 兼容：若缺少 delta_by_type_json，启动时尝试 ALTER TABLE 添加；失败不阻断主流程，仅跳过写入 delta。
  - 其他（背景表）
    - 与索引无直接耦合的行情表/缓存表（candles/candles_cache 等）不参与本索引模块，保持职责清晰。

- 统计方法与定义

  - 写前与写后数据集
    - 写前（old_list）：select_symbol_index() 全表快照（仅用于差分统计）。
    - 写后（DB 实时聚合）：根据 symbol_index 分组统计（type 与 type×market）。
  - delta_by_type 计算
    - key point three-sets 差分：
      - 新集合（new_items）：本次合并后要写库的条目。
      - 旧集合（old_list）：写前 DB 全量。
      - 交集/差集：
        - only_new = new_syms - old_syms（按新条目 type 计数 new）
        - inter = new_syms ∩ old_syms（按新条目 type 计数 updated）
        - untouched = old_syms - new_syms（按旧条目 type 计数 untouched）
      - total：用写后 DB 的 by_type 覆盖 delta_by_type.total，保证一致性。
  - 快照写入
    - key point insert_symbol_index_summary(snapshot_at, total_rows, by_type, by_type_market, delta_by_type)。

- API 契约（只读）

  - GET /api/symbols/index
    - 功能：返回当前 DB 中的 symbol_index 列表，构建状态（building）、行数、最近更新时刻。
    - 入参：refresh=1 可触发后台刷新（异步），不阻塞本次请求。
    - 返回：{updated_at, rows, building, items: [...], trace_id}
  - POST /api/symbols/refresh
    - 功能：手动触发刷新（异步），立即返回 ok=true, building=true。
  - GET /api/symbols/summary
    - 功能：返回 by_type、by_type_market，并尽量附带 latest_delta 与 snapshot_at。
    - 返回：{by_type, by_type_market, latest_delta, snapshot_at, trace_id}

- 并发与重试
- key po 抓取 future.result(timeout=180)；超时记 WARN 日志，数组置空，不中断整体。

- 观测与日志（NDJSON 单文件）

  - 全局日志文件：settings.log_file（默认项目根 chan-theory.log），50MB×5 滚动。
  - 日志级别：settings.log_level（DEV 默认 DEBUG、PROD 默认 INFO），可按模块覆盖 log_module_levels。
  - key point 关键事件记录
    - categories planned（最终执行顺序）
    - symbols.fetch.start/done/fail（含主/备函数名、耗时、行数）
    - symbols.merge.start/done（行数）
    - db.upsert.begin/done/skip（行数摘要）
    - symbols.refresh.start/done/fail（任务链路）
    - api.read/write（请求概览与状态码）
  - 字段裁剪：支持 summary 模式，仅保留概要；trace 定向 DEBUG 可放行细节。

- 边界与容错策略

  - key point 空结果不写：若合并结果为 0 行，跳过 UPSERT，保留旧数据，日志 WARN。
  - key point 不删除：不对 symbol_index 做 DELETE 操作。
  - key point 兜底合并：A 股主接口失败时，以上/深/北三所列表合并去重补齐。
  - 字段兼容：列名中英文差异，统一通过 \_norm_code_name 兼容（传入候选列名）。
  - 市场映射兜底：A 股与 ETF/LOF 各自独立的“前缀映射器”，保证 market 字段尽量有值。
  - ALTER TABLE 失败容忍：快照表新增列失败时，系统仍工作（仅 delta 不写）。

- 性能与可维护性

  - 性能
    - 单模块抓取不做大字典/全列拉取，仅提取必要列（代码/简称），降低 I/O 压力与限流风险。
    - 合并与 UPSERT 在内存与 SQLite 层均为轻量。
  - 可维护性
    - key point 模块职责清晰：路由薄（参数/返回），服务厚（抓取/合并/统计），DB 层仅提供 DDL/CRUD 接口。
    - 新类别扩展：新增 loader 与映射，注册到 loader_map 即可（但当前策略限定为 A/ETF/LOF）。

- 默认参数与建议（可在配置中调整）

  - fetch_concurrency：2
  - retry_max_attempts：2
  - retry_base_delay_ms：500
  - symbol_index_categories：["A","ETF","LOF"]（可删减或调整顺序）
  - DEBUG（开发 True / 生产 False）影响错误 detail 与日志级别

- 验收与回归建议

  - 初次刷新
    - POST /api/symbols/refresh → building=true
    - GET /api/symbols/index → rows > 0，items 中有 A/ETF/LOF 三类条目
    - GET /api/symbols/summary → by_type（含 A/ETF/LOF），latest_delta 含 new>0 且 total=写后总量
  - 配置变更（顺序与删减）
    - 调整 config.json 的 symbol_index_categories，如 ["ETF","A"]，再次刷新后 summary 应仅覆盖两个类型，rows 与 delta 更新合理。
  - 失败容忍
    - 模拟 akshare 某函数失败：应记录 WARN，返回空数组，但整体流程成功（其他类别仍入库）。
  - 回归日志
    - 查看 chan-theory.log 中 NDJSON 记录是否包含 plan/fetch/merge/upsert/summary 关键事件，并链路 trace_id 一致。

- 与前端对接说明（只读）

  - 前端无需改动；仍使用 /api/symbols/index, /api/symbols/summary, /api/symbols/refresh。
  - 如需前端增加“索引摘要卡片”，可读取 /api/symbols/summary 的 latest_delta 与 by_type 进行展示。

- 未来扩展（暂不启用，仅占位）
  - 类别扩展：INDEX/HK/US/CB/FUTURES/OPTION 等按相同模式扩展 loader 与映射。
  - 更细粒度统计：按市场细分 delta（目前仅 by_type）。
  - 指数/基金子类：在 type 字段之外加 subtype（可选），不破坏现契约。

### 17.2. 行情数据拉取操作规范

- 总则

  - 目前覆盖 A 股、ETF、LOF 三大类，按“主接口优先、备用降级”的方式明确每一频率的取数策略；交易日历、分钟会话与重采样保持“右端对齐”语义；仅做近端判定与整窗直拉，不做“近窗/窗外”分段策略。

- 适用范围与原则

  - 适用标的类型：A 股（沪深京）、ETF、LOF。
  - 适用频率：1m/5m/15m/30m/60m、1d/1w/1M（不含 120m）。
  - 统一时区与对齐：
    - key point Asia/Shanghai 全链路
    - key point 右端对齐（label=right）
  - 仅在“近端”判定是否补拉：
    - key point 只比较“应当已生成的最后一根 K 的结束时刻 end_ts_expected”与本地 cache_meta.last_ts；不做左端历史覆盖或缺口合并。
  - API 契约不变（/api/candles）：
    - key point 返回结构与字段不变
    - key point meta.downsample_from 在本地重采样时按实际赋值（"1m" 或 "1d"），否则为 null
    - key point meta.source 可为 em/sina/ak/tx/resample（重采样）

- 标的类型识别与路由

  - 首选：读取本地 symbol_index 的 type（A/ETF/LOF）。
  - 兜底（当索引未命中时，尽量不使用）：基于代码前缀做弱判断
    - A：600/601/603/605/688/689（SH）、000/001/002/003/300/301（SZ）、43x/83x/87x/…（BJ）
    - ETF/LOF：六位数 5xxxx/51xxx/56xxx/58xxx（多为 SH）、15xxxx/16xxxx（多为 SZ）；但 ETF/LOF 之间仅靠代码前缀难以精准区分，建议以索引为准

- 交易日历与会话

  - 交易日历（主用）
    - key point ak.tool_trade_date_hist_sina
    - 返回 1990-12-19 至 2024-12-31 的交易日集合（含补充 1992-05-04）
    - 失败回退：Mon–Fri
  - 会话时段（A 股、ETF/LOF 同步）：
    - 上午 09:30–11:30；下午 13:00–15:00
  - 非交易日：当天不应生成任何条，近端判定直接达标

- 频率支持与重采样级联

  - 原生分钟频率（源可直接提供）：1/5/15/30/60
  - 本地重采样支持：
    - 分钟族：1m → 5/15/30/60m（会话切片、右端对齐）
    - 日 → 周/月（W-FRI / 月末），ts 设为该组最后一天的 15:00

- 数据源映射与优先级（主接口 + 备用降序）

  - A 股
    - 分钟/粗分钟（1/5/15/30/60）
      - 主：ak.stock_zh_a_minute（新浪分钟，最近交易日）
      - 备：ak.stock_zh_a_hist_min_em（东财历史分钟）
    - 日/周/月（1d/1w/1M）
      - 主：ak.stock_zh_a_hist（period='daily'|'weekly'|'monthly'，adjust=""）
      - 备 1：ak.stock_zh_a_daily（新浪日线，支持 adjust；可用于应急）
      - 备 2：ak.stock_zh_a_hist_tx（腾讯日线，period='daily'，应急）
    - 复权因子（A 股）
      - key point 主：ak.stock_zh_a_daily(adjust='qfq-factor'|'hfq-factor')（直接取因子）
      - 备：从 stock_zh_a_hist 的 qfq/hfq 与 none 比值推导（仅应急）
  - ETF
    - 分钟/粗分钟（1/5/15/30/60）
      - 主：ak.fund_etf_hist_min_em（东财 ETF 分时）
      - 备用：无
    - 日/周/月（1d/1w/1M）
      - 主：ak.fund_etf_hist_em（东财 ETF 历史）
      - 备 1：ak.fund_etf_hist_sina（新浪 ETF 历史）
  - LOF
    - 分钟/粗分钟（1/5/15/30/60）
      - 主：ak.fund_lof_hist_min_em（东财 LOF 分时）
      - 备用：无
    - 日/周/月（1d/1w/1M）
      - 主：ak.fund_lof_hist_em（东财 LOF 历史）
      - 备用：无
  - 实时/盘口/行情（仅作辅助诊断或 UI 叠加，不产出烛形序列）
    - A 股实时概览：ak.stock_zh_a_spot_em、ak.stock_sh_a_spot_em、ak.stock_sz_a_spot_em、ak.stock_bj_a_spot_em、ak.stock_new_a_spot_em、ak.stock_cy_a_spot_em、ak.stock_kc_a_spot_em
    - A 股盘口：ak.stock_bid_ask_em
    - A 股新浪实时：ak.stock_zh_a_spot（谨慎使用，易被限频）
    - ETF/LOF 实时列表：ak.fund_etf_spot_em、ak.fund_lof_spot_em（用于代码/名称/简单现价展示，不作为 K 线源）

- 近端唯一判定（分钟/日/周/月）

  - 计算应当已生成的最后一根 K 的“结束时刻 end_ts_expected”
    - 分钟/粗分钟（1/5/15/30/60）
      - key point 宽限：默认 5 秒
      - 将 now-宽限 投影到会话：
        - 若在会话内：向下对齐到该频率右端；不超过本会话右端
        - 若在午休：取上午 11:30；若收盘后：取当天 15:00；若开盘前：取上一交易日 15:00
    - 日线（1d）
      - key point 宽限：默认 180 秒
      - 若 now-宽限 ≥ 今天 15:00 → 取今天 15:00；否则取上一交易日 15:00
    - 周线（1w）
      - key point 宽限：默认 180 秒
      - 本周最后一个交易日 15:00（简化为 W-FRI 回退至最近交易日）；未到达则取上周最后一个交易日 15:00
    - 月线（1M）
      - key point 宽限：默认 180 秒
      - 自然月末最后一个交易日 15:00；未到达则取上月最后一个交易日 15:00
  - 近端验证
    - key point 若 cache_meta.last_ts ≥ end_ts_expected → 达标；否则触发整窗直拉

- 整窗直拉与裁剪返回

  - 触发条件：近端未达标或该分区首次请求（无 meta）
  - 行为：
    - key point 整窗直拉：start=1990-01-01 00:00:00，end=当前时刻（分钟需 'YYYY-MM-DD HH:MM:SS'，日/周/月需 YYYYMMDD）
    - key point 接受上游“左端滚动限制”（分钟 1 分钟近 5 日等）；整窗直拉得到的结果也只是“近窗有限数据”，只要近端达标即可
    - 落库：
      - A 股 1d → 长期表 candles（adjust='none'）+ 因子 adj_factors
      - 其余频率（含 周、月、分钟）→ 缓存表 candles_cache + cache_meta（rows/first_ts/last_ts）
    - 重采样：
      - key point 若分钟族直拉失败或不足，可从 1m 本地重采样为 5/15/30/60m；周/月从 1d 本地重采样
      - 重采样严格右端对齐，按会话切片
    - 最终裁剪：按请求窗口 start/end 从本地裁剪返回

- 请求参数规范与衔接

  - 前端传参规范
    - key point start/end 统一标准化为 YYYY-MM-DD（后端再转 YYYYMMDD 或 'YYYY-MM-DD HH:MM:SS'）
    - include 指标：如 "vol,ma,macd,kdj,rsi,boll"
    - ma_periods：如 JSON 对象字符串：'{"MA5":5,"MA10":10}'
    - adjust：A 股已支持 qfq/hfq（按因子即时计算）；ETF/LOF 当前不复权
  - 后端拉取参数
    - A 股日/周/月：stock_zh_a_hist(period, adjust="")，日期 YYYYMMDD
    - A 股分钟：stock_zh_a_minute 或 stock_zh_a_hist_min_em（按优先级），日期时间字符串
    - ETF/LOF 日/周/月：fund_**hist_em；分钟：fund**\_hist_min_em

- meta.source 与归一化

  - key point meta.source 标记
    - 分钟（A/ETF/LOF）与 ETF/LOF 日/周/月：em 或 sina（A 股分钟优先 sina）
    - A 股日/周/月：ak；重采样：resample
  - 归一化：
    - 输出字段固定为 ts/open/high/low/close/volume/amount（amount 若源无则为 NA）
    - 分钟级时间戳从 'YYYY-MM-DD HH:MM:SS' 转为 Asia/Shanghai epoch ms

- 指标计算与响应

  - 指标
    - key point 服务端基于返回序列计算：VOLUME（总是返回）以及用户请求的 MA/MACD/KDJ/RSI/BOLL（纯函数）
  - 响应
    - candles：[{t(ISO8601, Asia/Shanghai), o,h,l,c,v}]
    - meta：symbol, freq, adjust, rows, start, end, generated_at, timezone, source, source_key, downsample_from, is_cached, trace_id
    - indicators：各指标序列（缺失点 None）

- 存储策略与表

  - 长期表（candles）：仅 A 股日线（adjust='none'）
  - 因子表（adj_factors）：A 股日线因子（qfq_factor/hfq_factor）
  - 缓存表（candles_cache）：非 A 日线的所有频率；A 周/月与 A 分钟也入缓存
  - 缓存元（cache_meta）：记录分区 last_ts/rows/first_ts/last_ts；用于近端判定

- 错误与可观测性

  - 不做网络分块；失败按优先级降级，兜底重采样（如适用）
  - 轻量日志：打印整窗直拉的 symbol/freq/窗口/返回行数；写入缓存前后行数与 meta 重建摘要
  - 断言：写入缓存时断言列数与 SQL 匹配，DEBUG 下提前暴露结构问题

- 自动前端刷新与轻冷却

  - 自动刷新
    - key point 分钟：按步长滚动计算下一个右端时刻 + 5s 宽限；日/周/月：按 15:00 + 180s 在相应粒度时刻调度
    - 盘后/非交易日不调度
  - 冷却（前端侧）：默认 10s，针对同一 (code,freq,start,end,adjust) 的连续触发

- 已知限制与取舍

  - 分钟 1 分钟近 5 日且不复权（由上游接口限制）时，整窗直拉仅能获得近端有限数据（但近端判定可满足）
  - ETF/LOF 分钟备用接口缺失；分钟级只能依赖 fund\_\*\_hist_min_em；降级策略仅限重采样（非跨源）
  - 会话切片与右端对齐必须严格执行，避免跨会话合并
  - 更精确节假日/临时停市需更完整的交易日历（当前以 tool_trade_date_hist_sina + Mon–Fri 回退即可）

- 最终主备清单（降序优先级）

  - A 股分钟：stock_zh_a_minute → stock_zh_a_hist_min_em
  - A 股日/周/月：stock_zh_a_hist → stock_zh_a_daily（Sina） → stock_zh_a_hist_tx（Tencent）
  - A 股复权因子：stock_zh_a_daily(adjust='qfq-factor'|'hfq-factor')
  - ETF 分钟：fund_etf_hist_min_em（无备）
  - ETF 日/周/月：fund_etf_hist_em → fund_etf_hist_sina
  - LOF 分钟：fund_lof_hist_min_em（无备）
  - LOF 日/周/月：fund_lof_hist_em（无备）
  - 实时/盘口/类目（非烛形源，仅辅助）：stock_zh_a_spot_em / stock_sh_a_spot_em / stock_sz_a_spot_em / stock_bj_a_spot_em / stock_new_a_spot_em / stock_cy_a_spot_em / stock_kc_a_spot_em、stock_bid_ask_em、fund_etf_spot_em、fund_lof_spot_em、stock_zh_a_spot（谨慎）

- 与实现的映射说明
  - fetch_period_ms 路由扩展
    - key point A 股 vs ETF/LOF 按 type 选择不同主接口族（stock*\* vs fund*\*）
    - key point 本地重采样仅用于 1m→高分钟 与 1d→周/月 的兜底；不支持 120m
  - market.get_candles
    - key point 延续“近端唯一判定 + 整窗直拉 + 缓存 + 指标 + 响应”的流程
    - key point meta.source/source_key/downsample_from 按实际来源与重采样填充

### 17.3. 前端信息显示层技术规范

- 总则
  - 本文档归档当前（最新一轮改造后）前端“信息显示相关”的全部规则与技术要求，覆盖：
    - 标的输入与控制条
    - 主行情窗（K 线/分时）
    - 量窗（成交量/成交额）
    - 技术指标窗（MACD/KDJ/RSI/BOLL）
    - 渲染、交互、状态指示、标题显示机制
    - 数据绑定与重绘时序、导出、性能与一致性约束
  - 目标：为未来追溯与扩展提供结构化、可执行的参考。
- 总览（UI 布局与职责）
  - 整体结构
    - 控制条（画布外）：仅主行情窗有，负责“周期切换按钮”等全局交互，不占用绘图区空间。
    - 每个窗体内部（画布内）分三段：
      - 顶栏 top-info（固定 28px 高）：功能按钮/选择器 + 标的信息 + 状态/统计等，悬浮于图表之上。
      - 绘图区 canvas-host：ECharts 渲染区域，顶部预留 28px，底部预留拖拽把手空间。
      - 底部拖拽把手 bottom-strip：支持上下调节窗体高度。
    - 多窗体缩放同步：通过 zoomSync 统一横轴 index（主图/量窗/指标窗对齐）。
  - 主题与样式
    - CSS 变量驱动主题（global.css）：背景/坐标/文字/涨跌色统一管理。
    - ECharts v6：选项生成采用纯函数，禁用不必要动画，默认 Canvas。
    - 画布内顶栏：z-index 提升（≥5），应用轻微半透明渐变背景，确保在任意图层之上清晰可见。
- 标的输入与控制条（SymbolPanel + 控制条）

  - 标的输入

    - 输入框支持代码/中文/拼音首字母，本地 Local-first 索引，后端 /api/symbols/index 异步刷新。
    - 下拉建议：支持键盘 ArrowUp/Down/Enter，通过 hotkeys 作用域 panel:symbol。
    - 失焦/回车提交流程：优先代码精确匹配，未命中再按中文/拼音搜索首项。
    - 热键作用域：focus 时 pushScope("panel:symbol")，blur 时 popScope，避免全局键位冲突。
    - 高级区间：支持手动日期、近 N 根、将当前可见窗口应用为数据窗口。
    - 导出菜单：分体式按钮，支持 PNG/JPG/SVG/HTML 快照导出（默认合规模式不内嵌原始数据）。

  - 控制条（画布外，仅主窗）
    - 周期切换：连体按钮（日/周/月/1m/5m/15m/30m/60m），点击后应用该周期的“默认时间窗口预设”。
    - 默认窗口预设（按频率）：
      - 1m: 5D；5m: 1M；15m: 1M；30m: 3M；60m: 6M；1d: 1Y；1w: 3Y；1M: 5Y。
    - 刷新：显式刷新按钮触发后端 /api/candles，主窗会显示工作状态（见状态指示章节）。

- 标题显示与更新机制（统一规则）

  - 标题格式：名称（代码）-频率（复权）。示例：“贵州茅台（600519）：1d 前复权”、“华夏银行（600015）：15m 不复权”。
  - 命名来源：本地 symbol index（Local-first），未命中时仅显示“代码-频率”。
  - 更新时序：
    - 加载中（vm.loading=true）：保持旧标题，不提前显示新参数，避免“半刷新”误导。
    - 加载完成（vm.loading true→false）且完成一次渲染后：切换为新标题。
  - 生效范围：主行情窗、量窗、技术指标窗均遵循该机制。

- 主行情窗（MainChartPanel）
  - 画布内顶栏（左 → 右）
    - 左：标题（名称（代码）-频率）。
    - 右：状态徽标（更新中… / 已刷新 HH:MM:SS）。
  - 渲染规则
    - 选项生成：buildMainChartOption（K 线或分时 + MA 系列），纯函数。
    - 支持 K 线样式：蜡烛（candlestick）或 HL 柱图（bar）。
    - 复用 dataZoom 的策略：
      - 当频率变化或旧 dataZoom 超出新数据范围时，不继承旧 dataZoom（避免周线空白）。
      - 否则继承上一次 dataZoom，保持用户的可见范围不抖动。
  - 键盘交互
    - 容器可聚焦（tabindex=0）。左右箭头在当前序列上移动高亮与 tooltip。
  - 设置
    - 双击主窗打开 MA/样式设置，支持线宽/线型/颜色/周期/样式等，保存后立即重绘。
- 量窗（VolumePanel）
  - 画布内顶栏（左 → 中 → 右）
    - 左：量/额切换（连体按钮）。
    - 中：标题（名称（代码）-频率）。
    - 右：统计信息（随可见窗口变化实时更新）：总量/均值/最大/放量天数/连续缩量。
  - 渲染规则
    - 选项生成：buildVolumeOption（bar + MAVOL lines + 放/缩量标记）。
    - 模式切换：vol=成交量；amount=成交额。立即重绘。
    - 主动重绘：监听 vm.candles、vm.indicators、vm.freq、用户设置变化，任意变化后即刻重绘。
    - 标记：放量/缩量阈值相对于启用的 MAVOL 最小周期的平均量。
  - dataZoom 与统计
    - 顶部留出 28px，底部留出 8px 把手；dataZoom 的变化会触发“可见窗口统计”的实时更新。
  - 设置
    - 双击量窗打开样式设置（柱宽/涨跌色、MAVOL 样式、放缩量符号/颜色/阈值）。保存后立即重绘。
- 技术指标窗（IndicatorPanel）
  - 画布内顶栏（左 → 中 → 右）
    - 左：指标种类下拉（MACD/KDJ/RSI/BOLL/OFF）。
    - 中：标题（名称（代码）-频率）。
    - 右：关闭按钮。
  - 渲染规则
    - 选项生成：
      - MACD：bar(HIST) + 2 条线（DIF/DEA）。
      - KDJ：K/D/J 三条线。
      - RSI：单线。
      - BOLL：当前复用 RSI 容器（可按需替换实现）。
    - 主动重绘：监听 vm.candles、vm.indicators、vm.freq、当前指标种类变化，即刻重绘。
  - 设置
    - 双击打开设置弹窗（当前保留主体结构，样式细节可按需拓展）。
- 渲染与重绘策略（统一约束）

  - 变化即重绘：以下变化会触发目标窗体渲染（setOption）：
    - vm.candles / vm.indicators / vm.freq / vm.chartType / 用户样式或配置。
  - 首屏（F5/Ctrl+F5）：所有窗体首帧会自动渲染，不需要用户手动交互。
  - 标题切换：在 watch(vm.loading) 中处理：仅当 loading=false 且 nextTick 立刻完成一次 setOption 后，才更新标题。
  - dataZoom 继承：
    - 主窗：频率变化或越界时重置范围，避免空白（周度修复）。
    - 量窗/指标窗：默认继承；当主动强制重绘（如模式切换/样式变更）可选择不继承以保证可见范围合理。

- 多窗体缩放同步

  - 机制：zoomSync.attach(key, chart, getLen) 将窗体加入同步组，统一横轴索引范围。
  - 广播策略：由触发窗体将 startIndex/endIndex 换算百分比广播给其它窗体，避免相互递归。
  - 新窗体挂载：若当前已有统一范围，会立即应用到新图，保证首帧对齐。

- 数据绑定与状态管理（useMarketView）

  - 核心状态
    - code/freq/start/end/chartType/adjust：标的与频率/时间窗口与图形类型/复权。
    - candles/indicators/meta/loading/error：数据与元信息、加载状态与错误。
    - rng：用户选择的区间模型（预设/手动/近 N 根 + 可见窗口）。
    - maPeriodsMap：固定键（MA5/MA10/…）映射周期，传递后端 include/ma_periods JSON。
  - 自动刷新
    - 按频率计算下一数据边界时刻（分钟步长、日/周/月 15:00 + 宽限），到点自动 reload。
  - 轻冷却
    - 默认 10 秒轻冷却避免频繁请求（用户强制刷新忽略冷却）。
  - include 参数
    - 总是包含 vol；根据用户设置按需包含 ma/macd/kdj/rsi/boll，减少后端计算与网络负载。
  - 错误处理
    - 错误仅在前端显示，不改变标题状态；下次成功刷新后恢复。

- 标的索引与名称解析（useSymbolIndex）

  - Local-first：优先使用 localStorage 缓存索引；后端 /api/symbols/index 可异步刷新写入本地。
  - 拼音支持：动态加载 tiny-pinyin（可选），用于中文 → 拼音与拼音首字母检索；依赖缺失时降级为代码/中文匹配。
  - 标题名称来源：标题显示使用 findBySymbol(code) 获取 name，未命中仅显示代码。

- 工具与服务

  - 图表选项（charts/options.js）

    - 主图：K 线/分时 + MA；tooltip 左对齐、圆点标色、智能左右避让。
    - 量窗：bar + MAVOL；放/缩量标记与柱底齐平，符号宽度与柱宽自适应；tooltip 显示量/额与 MAVOL，并带颜色圆点。
    - 指标窗：MACD/KDJ/RSI（BOLL 复用容器）；tooltip 统一风格。
    - 缩放同步：提供 attach/detach/setRangeByIndex，统一 dataZoom。

  - 导出

    - ExportController：注册/注销导出目标（主窗/量窗/指标窗），统一互斥调度，默认合规快照（不内嵌原始数据）。
    - 文件名策略：symbol*freq*时间戳.ext，格式统一。
    - HTML 快照：自包含，使用 ECharts v6 CDN，默认 includeData=false。

  - HTTP 客户端（api/client.js）
    - x-trace-id：请求拦截器自动注入，便于后端日志对拍。
    - DEV 日志：仅在开发环境打印请求快照，生产环境关闭噪音。

- 热键（hotkeys）

  - 全局
    - Alt+R 刷新数据；Alt+E 打开/关闭导出菜单。
    - Ctrl+Comma 打开快捷键设置；F1 帮助。
  - panel:symbol（标的输入）
    - ArrowDown/ArrowUp/Enter/Escape 控制下拉与提交。
  - modal:settings（设置弹窗）
    - Escape 关闭；Ctrl/Cmd+Enter 保存
  - 插件 - userOverrides 是响应式（ref），hotkey 插件 watch 该 ref，保存后立刻生效。

- 性能与一致性

  - 渲染负担控制
    - 默认禁用昂贵效果，合理设置线宽/平滑；MAVOL/MA 数量可配。
  - dataZoom 继承
    - 主窗在频率变化或越界时重置范围，避免空白（周度修复）。
  - 首帧自适应
    - onMounted 后 nextTick + requestAnimationFrame 进行首帧 resize，规避冷启动尺寸抖动。
  - 状态一致
    - 标题更新与状态徽标遵循统一时序：加载中 vs 加载完成。
    - 量/额切换、指标切换等强制重绘场景，必要时不继承旧 dataZoom 以保证可见范围合理。

- 组件级规范（摘要）

  - MainChartPanel

    - 画布外：周期按钮。
    - 画布内顶部：标题（左）+ 状态（右）。
    - 画布内中部：绘图区。
    - 画布内底部：拖拽把手。
    - 键盘：左右箭头移动当前点。

  - VolumePanel

    - 画布内顶部：量/额切换（左）+ 标题（中） + 统计（右）。
    - 画布内中部：绘图区（bar + MAVOL + 标记）。
    - 画布内底部：拖拽把手。
    - 双击打开设置（柱体/MAVOL/标记）。

  - IndicatorPanel
    - 画布内顶部：指标下拉（左） + 标题（中） + 关闭（右）。
    - 画布内中部：绘图区（按指标类型渲染）。
    - 画布内底部：拖拽把手。
    - 双击打开设置（保留结构，可扩展样式项）。

- 接口契约与后端配合（只列显示层相关）

  - /api/candles（前端统一调用）

    - 参数：code、freq、start、end、include（vol,ma,macd,kdj,rsi,boll）、ma_periods（JSON 字符串）。
    - 返回：candles、indicators、meta（含 symbol/freq/rows/start/end/generated_at/timezone/source/source_key/downsample_from/is_cached/trace_id）。
    - 约束：ma_periods 使用固定键（MA5/MA10/…），防止前端 MA key 不稳定。

  - /api/symbols/index
    - 用于前端索引刷新（Local-first）；名称显示依赖该索引。

- 验收与回归要点

  - 首屏（F5/Ctrl+F5）：主窗/量窗/指标窗均应自动显示，不需要任何交互。
  - 标题显示：加载中保持旧标题；加载完成并渲染后切换为新标题（含名称、代码、频率、复权）。
  - 状态徽标（主窗）：加载中显示“更新中…”，完成后显示“已刷新 HH:MM:SS”并在 2 秒后自动隐藏。
  - 量/额切换：按钮可见，切换后即时渲染；统计与 tooltip 正确显示。
  - 周度修复：从其他周期切到周线，主窗应正常显示（不空白）；dataZoom 合理重置。
  - 多窗体对齐：缩放任一窗体，其它窗体横轴严格对齐。

- 变更记录（本轮关键）

  - 画布内顶栏统一：主窗/量窗/指标窗均使用 top-info（28px），安排按钮/标题/状态或统计。
  - 标题统一时序：loading=true 保持旧标题；loading=false 且 setOption 完成后切换新标题。
  - 主窗支持图形样式切换：蜡烛 vs HL 柱图。
  - 主动重绘：量窗与指标窗补齐对 candles/indicators/freq/设置 的监听，刷新后无需交互可见。
  - 量窗顶栏恢复并可见性增强：z-index 提升 + 顶栏轻微渐变背景，避免被绘图“视觉遮挡”。

（其余内容若与当前实现一致则保持不变）
