# 缠论各元素识别规则及绘制方法 v1.0

## 文档更新说明

- **key point 本版统一术语为“合并K线”**（即去包含后的K线），不再使用“HL柱”的称谓。
- **key point 分型的一般规则允许强分型、标准分型、弱分型之间共用合并K线**（即同一根合并K线可以同时参与多个分型的三根结构）。
- **key point 确认分型规则保持严格**：确认分型必须由连续六根合并K线组成两个相邻的同向分型，两个分型之间既不能重叠（不可共用合并K线），也不能相离（中间不可夹独立合并K线）。
- **key point 确认分型的极值比较采用严格不等**：同为顶分时，第一组的中柱最高点严格高于第二组的中柱最高点，且第一组右柱最高点严格高于第二组左柱最高点；同为底分时，第一组的中柱最低点严格低于第二组的中柱最低点，且第一组右柱最低点严格低于第二组左柱最低点。
- **key point 显著度门槛预留但默认不启用**：最小价差与最小百分比门槛的设置项保留，当前默认为零，不参与筛选。

---

## 合并K线（处理包含关系）

- **定义与目的**：合并K线是将相邻K线之间的包含关系去除后得到的“精简K线”。它保留每根的唯一最高点与最低点，体现结构性拐头，减少随机噪音。
- **使用原则**：
  - **key point 后续所有识别与绘制均以合并K线为唯一基准**，不再回看原始K线。
  - 每根合并K线都具备方向属性（上涨或下跌），以及明确的最高点与最低点，用于后续的分型判定与力度分档。
- **直觉提示**：把一段复杂的细碎波动折叠为更少但更有代表性的关键节点，便于手工标注与结构识别。

---

## 分型

默认你在主图上能看到合并K线与分型标记；若没有，也请尽量按“合并K视角”理解与执行。下面是一套面向人工手画与显示层标注的简化、可执行规则。

### 一、准备与统一口径

- **key point 以合并K线为唯一基准**：所有分型判定、强弱分档与确认关系，仅看合并K线的序列与极值。
- **key point 分型的承载点为中柱**：顶分型与底分型均以三根结构中的第二根（中柱）作为定位与标注点。
- **key point 中点的统一定义**：一根合并K线的“中点”是该根最高点与最低点的平均位置。强弱分档统一以第一根的中点为参照。
- **显著度门槛（预留）**：为后续降噪预留“最小价差”与“最小百分比”的门槛设置项，当前默认值为零（不开启筛选）。
- **key point 同时跟踪双向极值**：从最左端开始同步维护“当前最高顶分”与“当前最低底分”，每次出现更极值都立刻修正；避免因“首遇分型”导致起点偏向。

### 二、分型的基本判定（方向序列为第一准则）

- **顶分型（上转下）**：从左到右观察三根合并K线，若第二根表现为上涨、第三根表现为下跌，则判定为顶分型；中柱为定位与标注点。
- **底分型（下转上）**：从左到右观察三根合并K线，若第二根表现为下跌、第三根表现为上涨，则判定为底分型；中柱为定位与标注点。
- **极值标注**：
  - 顶分型以中柱的最高点进行标注；
  - 底分型以中柱的最低点进行标注。
- **共用规则（一般情况）**：
  - **key point 一般允许分型之间共用合并K线**：同一根合并K线可以同时参与多组分型的三根结构，无需强制“非重叠”。

### 三、强弱分档（以三根的极值与第一根中点为准）

- **顶分型的强弱分档**（三根从左到右为第一、第二、第三）：
  - 标准顶分：第三根的最低点位于第一根的最低点与第一根的中点之间（包含两端点）。
  - 弱顶分：第三根的最低点高于第一根的中点（回落力度偏弱）。
  - 强顶分：第三根的最低点低于第一根的最低点（回落力度偏强）。
- **底分型的强弱分档**：
  - 标准底分：第三根的最高点位于第一根的中点与第一根的最高点之间（包含两端点）。
  - 弱底分：第三根的最高点低于第一根的中点（反弹力度偏弱）。
  - 强底分：第三根的最高点高于第一根的最高点（反弹力度偏强）。
- **直觉理解**：顶分型看“第三根跌到哪里”（跌得越深越强）；底分型看“第三根涨到哪里”（涨得越高越强）。

### 四、确认分型（双分型紧邻且严格不等）

- **结构要求**：
  - **key point 必须由连续六根合并K线组成**两个相邻的同向分型：第一组三根与第二组三根紧密相接，正好覆盖六根合并K线。
  - **key point 两个分型之间既不能重叠也不能相离**：不允许共用合并K线；也不允许在两组分型之间夹任何独立合并K线。
- **极值比较（严格不等）**：
  - 同为顶分时：第一组的中柱最高点严格高于第二组的中柱最高点，并且第一组右柱最高点严格高于第二组左柱最高点。
  - 同为底分时：第一组的中柱最低点严格低于第二组的中柱最低点，并且第一组右柱最低点严格低于第二组左柱最低点。
- **结论意义**：满足以上结构与比较关系，视为对前一分型的“确认分型”，提示其更可能是一次转折而非中继。

### 五、常见误区与自检要点（分型专项）

- **只看合并K线**：所有判断以合并K线为基准，不用原始K线高低或根数。
- **承载点唯一**：分型的定位点是三根中的中柱；顶分标注中柱的最高点，底分标注中柱的最低点。
- **一般允许共用**：分型之间一般允许共用合并K线；**确认分型除外**，必须严格由六根合并K线构成，且不可共用、不可相离。
- **强弱分档靠位置**：顶分看第三根的最低点与第一根的最低点和中点的相对位置；底分看第三根的最高点与第一根的中点和最高点的相对位置。
- **确认分型要严格不等**：仅接受“更低的低点与整体下移”或“更高的高点与整体上移”，不考虑“相等”。
- **显著度门槛先为零**：前期不筛；当图面分型过密时再按需要启用“最小价差或最小百分比”的门槛。

### 六、一个直觉例子（帮助手感）

- 在一段上涨后突然出现“第二根上涨、第三根下跌”的三根结构，即顶分型；第三根的最低点介于第一根的最低点与第一根的中点之间，为“标准顶分型”。
- 紧接着又出现另一组三根“第二根上涨、第三根下跌”，两组共覆盖六根合并K线，中间没有任何独立合并K线，也没有重叠；新的第一根整体低于上一组的第三根（最高点与最低点都更低），新的第二根的最高点也低于上一组的第二根最高点。此时，对第一组构成“确认顶分型”，提示其更可能是转折。

---

## 笔

默认你在主图上能看到合并K线与分型标记；若没有，先将有包含关系的K线做合并处理，并完成分型识别与标记，再执行画笔操作。下面是一套面向人工手画笔的简化操作法（自然语言，面向实际手工标注）。

### 一、准备与统一口径

- **key point 以合并K线为基准判断间距**：所有间距与跨度判断都看合并K线，不看原始K线根数。
- **key point 分型的承载点=中柱**：顶/底分型均以其三根结构的中柱作为定位点。
- **key point 最小净间距阈值为3**：两次分型“承载点”的净间距（不含起止点）达到3，才允许成笔。直觉理解：两个分型之间，至少要有一根“既不属于前一分型窗口、也不属于后一分型窗口”的独立合并K线。
- **key point 端点必须是反向分型**：上行笔“底→顶”，下行笔“顶→底”，两端均为分型定位点。
- **key point 区间内严禁出现更大的极值**：对上行笔，区间内不得有“更低的底”或“更高的顶”；对下行笔，区间内不得有“更高的顶”或“更低的底”。一旦出现，必须立刻修正端点。
- **key point 首尾相连不变量**：上一笔的终点与下一笔的起点始终是同一个点；任何修正都必须同步维护这一不变量。
- **key point 相等不算“更大”**：只当“更高/更低”严格成立时才视为“更大极值”，相等不触发修正。
- **key point 没有“确认/预备”状态**：所有笔都可能因为后续极值而被修正，因此只需一直画到全量数据范围内能成立的最后一点为止。
- **key point 首笔同时跟踪双向极值**：首笔从最左端开始同步维护“当前最高顶分”与“当前最低底分”，每次出现更极值都立刻修正；避免因“首遇分型”导致起点偏向。

### 二、成笔“三硬条件”（必须同时满足）

1) 端点类型：起止点必须互为反向分型  

   - 上行笔：起点=底分型，终点=顶分型。  
   - 下行笔：起点=顶分型，终点=底分型。

2) 最小间距：两分型承载点的合并K净间距 ≥ 3  

   - 记法：间距 = 终点承载点rid − 起点承载点rid ≥ 4（等价于“含端点K线数”≥ 5），以“|idxTop - idxBottom| ≥ 4”表达。。

3) 极值排他：起止点之间“开区间”内不允许出现“比起止点更大的极值”  

   - 极值要比较的是顶分型的G点价格或底分型的D点价格。
   - 上行笔：区间内不得出现“底更低于起点底”或“顶更高于终点顶”。  
   - 下行笔：区间内不得出现“顶更高于起点顶”或“底更低于终点底”。

备注：任一条件不满足即不可成笔；若后续出现“更大极值”，需立即修正相应端点，再重查三条件。

### 三、画笔的人工操作法

按时间从左到右，同时跟踪顶分与底分两条“极值轨”：

1) 同步维护两端候选  
   - 自全量数据最左端起，同时维护“当前最高的顶分”和“当前最低的底分”，横坐标为顶底分型极值对应的合并K线横向位置，纵坐标为极值价格。  
   - 每当出现更极值（更高顶/更低底），立即修正对应一端的候选极值。

2) 第一笔的确定
   - 最初顶底两端候选均为空，分别把第一次遇到的顶底分型缓存至对应缓存器做为第一轮候选，一旦两端都已有候选分型（顶与底同时存在），立刻触发第一次间距检查（不含起止点的净距 ≥ 3）。
   - 如间距不满足则继续向右检索分型并做极值修正，任意一端发生修正时都立即再次触发间距检查。
   - 如间距满足成笔条件则第一笔成立，并根据此时的顶底分型位置确定起止点和笔方向。如顶分型在左则为下行笔（起点为顶分，终点为底分），如底分型在左则为上行笔（起点为底分，终点为顶分）。
   - 提示：第一笔的方向不做预设，由“起点分型与终点分型的组合”自然决定。

3) 起笔后的继续检索  
   - 第一笔落定后，把第一笔终点做为下一笔起点（各笔严格“首尾相连”），把下一笔终点缓存清空，从起点继续向右检索分型。
     - 后续各笔的方向均已随第一笔方向的确定而确定（必然是上行笔与下行笔交替出现，不可能连续出现同向笔），各笔起止点的分型方向也随当前笔方向确定而确定且交替改变。
     - 检索到的分型应严格与当前笔起止点的分型方向相对应，上行笔时起点只与底分比对是否修正，终点只与顶分比对，下行笔时起点只与顶分比对是否修正，终点只与底分比对，确保起止点的分型方向在每一笔中稳定不变且保持反向，后续在判断成笔条件时就不必再专门校核分型方向。

4) 后续笔的极值修正
   - 每当任一端出现更极值（如终点为空，把遇到的第一个与起点分型方向相反的分型缓存为终点，后续再做极值修正），先修正端点，再验成笔条件。
     - 当终点被更极值修正时，影响范围仅在当前笔，检索过程中已经通过约束条件保证了起止点分型方向相反，且通过极值修正始终保持每一笔内起止点都是极值，所以在检验成笔条件时只需要检验起止点间距即可。
     - 当起点被修正时，因前一笔终点也被同步修正了，首先要核检前一笔的起点是否需要修正（修正前的原终点到修正后的新终点之间是否出现了与原起点方向相同且更极值的分型），如前一笔的起点也被修正，则再向前追溯一笔核检前前一笔的起点是否需要修正，一直向前追溯到某一笔的起点无需修正为止，方可判定已充分修正到位。
   - 向左追溯稳定后，从稳定后的那一点开始向右逐笔校核起止点间距是否满足成笔条件（合并K净距≥3），如满足则确认该笔然后继续向右检核，如不满足则从该笔开始按统一规则重画后续各笔。
     - 不满足成笔条件包括两种情况：1. 间距不足；2. 终点为空的情况。
       - 终点为空可能因以下两种原因之一导致：1. 因起点修正右移而越过了原终点导致原终点失效清空，2. 原有各笔已检核完成来到新一笔即终点为空。
       - 如为间距不足则以当前笔的现存起点终点为现状继续向右检索画笔，如为终点为空则从起点开始继续向右检索画笔。
5) 按上述规则3、4循环往复，成笔后以前一笔终点做为下一笔起点继续向右检索，遇更极值立即修正，遇起点修正立即向左追溯检核，追溯稳定后重新向右检核、检索，直至本连续岛或全量数据检索完成。

### 四、现场修正与连锁回溯（遇更大极值怎么办）

遇到更大极值时，务必先修正极值（端点），再判断间距与区间极值是否合规：

1) 终点被更大极值替换：  

   - 立即重查“三硬条件”。若不满足，继续向右；满足则保持当前笔。

2) 起点被更大极值替换（起点右移）：  

   - 同步把“上一笔的终点”一起右移到该新起点（保持首尾相连）。  
   - 随即检查“上一笔”的区间是否被更大极值破坏：若是，上一笔的起点也要相应右移；并继续向更早的笔回溯……直到最早需要修正的那一笔也恢复合法（其区间内不再有“更大极值”）。  
   - 若本笔“起点右移后落到终点右侧”，则“终点立即失效清空”，待回溯稳定后，从新起点往右重新逐笔检核已有后续各笔的起止点是否满足成笔条件，如满足则继续向右逐笔检核，直至某一笔终点不满足或为空，则以此笔现状为起点开始重新画笔，右端原有各笔全部作废重画。

3) 修正优先级与尺度：  

   - 只要发现“更大极值”，先改端点，再查三条件；宁可多次小步修正，也不提前“凭间距成笔”。  
   - “相等”不视为更大，不触发修正。

### 五、笔的终止与数据边界

- 当因除息等原因导致K线连续性被破坏（断裂阈值按相邻交易日涨跌幅 > 静态阈值），则以断裂点为边界将全量数据切分为若干连续岛，画笔以断裂点为边界，确保笔不跨界。后续线段、中枢等均以笔为基础，因此线段、中枢也限制在连续岛内不跨界。
- 分岛规则如下：
  1. 使用相邻原始K作比对而不使用合并K；
  2. 使用静态阈值而不使用动态阈值（因改用原始K而限制了时间跨度为相邻交易日，无需考虑跨多日的情况），静态阈值建议为50%（各类标的包络考虑）；
  3. 排除新股上市前10日（前5日无涨跌幅限制），即默认前10个交易日为连续，从第11个交易日开始做比对（第10个原始K和第11个原始K比对）
  4. 涨跌幅比例算法：（当日H-前日C）的绝对值/前日C，（前日C-当日L）的绝对值/前日C。该两个比值中任意一个大于等于静态阈值则判定分岛，小于静态阈值则判定为连续。
- 一直自左向右画，直到连续岛或全量数据的最右端。遇连续岛界则终止当前连续笔，下一连续岛内重新起笔。
- 最后一笔：以数据右端为止，能满足“三硬条件”的最后一笔为终点；如果后续再出现“更大极值”，可继续修正并延伸。
- 不存在“确认/预备”之分，因后续仍可能修正。  

### 六、对称规则与判定口令

- 起止反向，净距够三，端点极值，落笔可变。
- 任何时刻：**先修极值，再验三条（反向/间距/无内极值），再落笔。**

### 七、操作小贴士与避坑清单

- **key point 先极值后间距**：绝不能“先看间距成笔、再修极值”；遇更大极值必须先改端点。  
- **key point 相等不作大**：相等不触发修正，避免无意义抖动。  
- **key point 开区间检查**：极值排他只看“起止之间”的开区间，不含两端。  
- **key point 首尾相连**：任何修正都同步维护“上一笔终点 = 下一笔起点”。  
- **key point 起点越过终点立即清空终点**：先稳定起点与回溯，再从新起点右侧重找终点。  
- **key point 看合并K不是看原始K**：计数与间距全部以合并K为准。  
- **key point 没有“最终确认”**：只需在当前数据区间内做到最后一笔满足即可，后续数据会继续触发修正。

### 八、可视检查清单（每笔必做“三问”）

1) 端点是不是“互为反向的分型承载点”？  
2) 两端承载点间距是否≥4（等价含端点根数≥5）？  
3) 两端之间是否没有更大的极值（上行：无更低底/更高顶；下行：无更高顶/更低底）？

若全部“是”，这笔当前成立；否则继续修正/检索。

### 九、术语速查与计数口径

- 合并K线：包含关系处理后的K线，作为唯一计数单位。  
- 分型承载点：三柱分型的中柱位置，用于定位起止端点。  
- 更大极值：上行看“更低的底 / 更高的顶”，下行看“更高的顶 / 更低的底”；严格不等。  
- 间距=4：指“终点承载点rid − 起点承载点rid ≥ 4”；等价“含端点K线数≥5”。  
- 开区间检查：只在起止承载点之间的内部检查是否出现更大极值；两端不算入内部。

用这套规则“看左打底、看右封顶；遇强者从之、修后再验；三条皆成，笔乃暂立；首尾相连，画至最末”。在实际标注中，始终坚持“先修极值、再验三条”的顺序，就能稳定地得到一致可复核的手工笔。

---

## 线段

- **暂未展开**：线段的识别与绘制方法将在后续版本补充。建议当前专注于“分型→笔”的稳定执行与显示。

---

## 中枢

- **暂未展开**：中枢的判定与标注依赖“笔与线段”的稳定输出，将在后续版本随线段规则一并补充。
